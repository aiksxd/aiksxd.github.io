+ Date: 2023-02-01 22:23:40
## 前言

+ 建议配合视频教程一起使用，这篇提供我已知的最优解，但**不一定是最好**；
+ 完成本地的直播网站需要一台满足配置要求的设备(能**带动OBS**+**内网穿透**且**承载**住他人的**拉流**；主要吃**CPU和宽带**，CPU方面基本上**一般电脑都可以**)，体量不大宽带家用蛮够，主要看映射软件给你开放的宽带（obs默认码率一个访问者流量传输约为**128KB/s**），如果面向人群体量稍大如班级可以考虑研究一下**p2p**技术，再大这则博客就没用了，大型的平台主要采用**CDN分发**和**p2p**；
+ 需要两条http协议的隧道，如果网页有托管可以直接对外公开的话可以只要一个隧道（Github是https打头，数据不和http互通，需要额外配置）

## 准备工作

除**内网穿透**需求**可能要多个**，**其他工具只要一个**即可

+ ### **网页部署工具**（选一）
> + **Windows自带**的**IIS组件**
>
> + [小皮面板phpStudy](https://www.xp.cn/)
>
> + [Vue.js渐进式 JavaScript 框架](https://cn.vuejs.org/)
>
> + [Hexo](https://hexo.io/zh-cn/index.html)

+ ### **推流工具**（选一）
> + [FFmpeg](https://ffmpeg.org/)
>
> + [OBS](https://obsproject.com/)

+ ### **流媒体中转服务器**（选一）
> + [LiveGo：纯 Golang 编写的直播服务器，性能高，跨平台](https://github.com/gwuhaolin/livego)
>
> + [nginx-rtmp-module：基于NGINX的媒体流服务器](https://github.com/arut/nginx-rtmp-module)
>
> + [Node-Media-Server：一个 Node.js 实现的RTMP/HTTP/WebSocket/HLS/DASH流媒体服务器](https://github.com/illuspas/Node-Media-Server)

+ ### **内网穿透工具（这里只列出支持http/https协议的)**(视频演示方法需要凑出**2条隧道**）

  > + [**cpolar**](https://www.cpolar.com/)：学习成本低；无需实名；无限流量；**动态域名**且**无**UDP；速度较低；**http**协议提供**免费动态域名**，**免费一条http**隧道
  > + [**飞鸽**](https://www.fgnwct.com/)：学习成本低；**0.5M**，签到给流量；**http**协议提供**免费域名**；**免费两条**隧道但**http只能一条**
  > + [**OpenFrp 内网穿透（需域名）**](https://www.openfrp.net)：学习成本低(带GUI启动器和樱花相似)免费，签到领流量；**部分节点**无需实名；速度**限制**12M/s(速度取决于所选节点与访客距离)；固定域名；**http**协议需要**绑定自己的域名**
  > + [**NATAPP**](https://natapp.cn/)：学习成本一般；**动态域名**；**实名**；1M；**http**协议提供**免费域名**
  > + [闪库](http://www.ipyingshe.com/)：1M/s；**仅支持Http**，**随机固定**域名；未来可能实名
  >   **（以下是其他我没用过的内网穿透）**
  > + [**ngrok(https)**](https://ngrok.com/)：学习成本一般；无需实名；只给**一条免费隧道**，离得近的节点延迟较低；http会**自动换https**协议（相当于**不支持http**）
  > + [**花生壳(https)**](https://hsk.oray.com/)：极低的学习成本；**实名1M**每月1G且**无Http只有https**，隧道固定域名
  > + **．．．．．．**（数据来源于2023.1，**可能不准确**如有需要在下面留言更新）

## 工作原理及其流程（视频配置）

+ ### 画面采集以及推流
> + OBS**添加采集源**（常用三个）：
> >  1. **显示器采集**（桌面画面）
> >  2. **游戏源**（全屏程序）
> >  3. **音频输入采集**（麦克风）
> + OBS**推流配置**
> > 1. OBS选择**设置** —>**推流**页面；**服务**选择**自定义**
> >
> > 2. **服务器**（推流地址）默认填**rtmp://127.0.0.1:1935/live/**（如果要改下面的**拉流地址**也要改一下）
> >
> > 3. **启动流媒体服务器LiveGo**并**获取channelkey**；在**浏览器地址栏**输入http://localhost:8090/control/get?room=movie
> >
> >    **并回车，复制给出的**channelkey**填写到OBS推流页面的**串流密钥**；
+ ### 内网穿透映射网站和http协议7001端口（两条隧道）
>**启动内网穿透工具**，此处以**NatApp和飞鸽为例**（需要**两条http隧道**在线）
>+ **飞鸽（映射80）**
>> 1.官网注册账号进入**控制台**
>>
>> 2. **开通隧道** —> 选一个**免费节点** —> **备注、前置域名自定义** —> **本地IP端口**后面的**端口改为80** —> **确认开通**
>> 3. 下载对应的**客户端**，此处以**带GUI的客户端**为例，将**隧道的id粘贴**进去**再启动隧道**即可
>+ **NatApp（映射7001）**
>> 1. 官网注册账号进入**仪表盘**
>> 2. **购买隧道** —> **免费隧道**：**隧道名自定义**；**Web类型**；**本地端口7001**
>> 3. 下载客户端，将authtoken复制粘贴到Natapp的配置文件中
>其中，**80端口**为**phpstudy部署网页的默认端口，**根据自己网站填写不同的，如**hexo使用4000**，**vue则为8080**
>**7001端口**为**LiveGo**提供的**HTTP-FLV传输协议的接口**
>**每个隧道映射成功**后**都会给一个**没有端口的**地址**，这个之后会用到
+ ### 网页播放器拉流并部署
> + **网页播放器配置**
> > **记事本**或其他**文本编辑器方式**打开**压缩包解压**后的LiveOnlineWeb\phpstudy_pro\WWW\index.html文件
> > 将**body**标签中的**script**标签内**播放器的url**改为**内网穿透映射7001端口后**给出的**地址** **+** **OBS推流地址端口后面的路径** **+ movie.flv**
> > **示例：url: 'http://xxxxxxxxx.xx.cpolar.top/live/movie.flv'**
> > **本地拉流地址：url：'http://127.0.0.1:7001/live/movie.flv'**
> > （本地视频流地址，只有**主机**能够拉流成功，其他人访问是拉自己设备该地址对应目录下的文件，故**其他人无法拉流成功**，**仅供自己测试**用，该地址**不会占用宽带**）
>  + ### 部署网站（PHPStudy为例）
>  > 1. 打开**PHPstudy**应用程序
>  > 2. 启动**WNMP服务**
>  > 3. 在**浏览器地址栏**输入**http://127.0.0.1:80** 或 **http://localhost** 即可进入**本地网页**（80可选填，都一样）
>  + **检验是否推流成功**
>  > **方法一：**在**浏览器地址栏中**直接**将url地址填入并回车**，检查浏览器是否能够**下载到一个名为movie.flv的文件**
>  >
>  > **方法二：**直接打开网站检查是否能加载出**直播画面以及声音**
>  >
>  > **问题排查：**
>  >
>  > + **方法二播放器黑屏**然后使用**方法一发现能够下载到流视频文件**，这时候只要**刷新**一下网站即可，再不行**OBS切断重新推流**再**刷新**
>  > + **直播画面有声音但是黑屏**，可能是**程序画面采用全屏方式运行**但在**采集源中没有对全屏应用的画面采集**，此时在**OBS采集源**中加入**游戏源**选择**采集任意全屏应用程序**即可；或者将**全屏程序**改为**窗口模式**或者**无边框模式**
>  > + **有电脑的声音但是听不到自己发的声音**，可能是**没有麦克风的采集源**，在OBS采集源**加入音频输入采集**；或者使用**其他手段**如**手机电脑加入同一个通话频道**，会自动采集通话程序的声音，就是回声可能相对严重，也会有一定延迟，此时建议使用**WO Mic**。
+ ### 结语
> 最后将**内网穿透映射网页端口提供的地址**分享给他人浏览即可，
> 其他人用**浏览器打开该地址**即可通过静态网页上的播放器就可以观看你的OBS推出的视频流画面。
+ ### 流程图直观展示
> + **本地拉流演示图**（不一定正确）
> ![本地拉流，看到该消息可能是图片加载失败，和视频里的流程图是一样的，可以去看视频当中的](https://s1.vika.cn/space/2023/03/23/6614de3f60d8477f8b58590ac45e6106)
> + **其他人观看直播原理演示图**（不一定正确）
> ![其他人观看直播原理，看到该消息可能是图片加载失败，和视频里的流程图是一样的，可以去看视频当中的](https://s1.vika.cn/space/2023/03/23/faecad8bb9a54c6b876d48f71fc077fa)

## 拓展

+ ### 解决内网穿透提供宽带速度不够的问题
> 这个问题我目前是采用**多线程**的方法解决的（整合包中我提供了line234页面并写好了超链接，根据需要自行填入映射好的7001本地端口地址到视频流的url），通过**启用多个内网穿透工具共同映射7001端口**，**分别**将**给定的地址**填入**不同的页面**，用户通过**切换页面**来**减少单个**内网穿透工具的**宽带压力**，以此实现宽带的拓展
+ ### 解决电脑没有麦克风的问题
倘若有人的主机电脑**没有麦克风或麦克风坏了**，正好有**手机在身边可以使用**的话可以使用**WO Mic**来解决这个问题
> #### WO Mic局域网连接使用教程
> + 流程图：
> ![如果看到该文段可能是图片加载失败了，去看视频吧](https://s1.vika.cn/space/2023/03/23/3334ed25ec2e4eb6a39aae16df9b7a38)
> 1. 手机端启动**WO Mic应用程序并运行**（在局域网广播）
> 2. 将给定的**局域网地址**填写到**电脑WO Mic Client的连接** —> **连接...** —> **手机IP地址**输入框中 —> 再点击**连接**即可
> + **手机端**控制**音量大小**和**是否传输声音**（=开关麦）；**电脑端**可以选择设置**本地播放**方便**调试声音**
## 总结
> **通过内网穿透直播**仅适合**面向小众群体**，例如**学生**等**无法与直播平台签约**或者**不想和直播平台签约**又**想体验直播**的人群，或者只是**单纯想挂在自己博客上**让访客碰运气看看有没有直播。
> 这项技术**优点**是**搭建迅速而且免费**（**不花钱可以使用，人数不多体验还是很好的**），**有域名**的话可以使用更好的映射软件，**它们提供更好的免费的宽带**，如**OpenFrp**（地址上面链接），感兴趣的可以尝试一下，我下面会发布**整合包的链接**（**不含内网穿透工具**和**推流工具**，**需自行额外安装**）
>
> + 蓝奏云
>   > https://wwxr.lanzoum.com/i1uKo0mhm3id
>   > 密码:civt
> + 百度网盘
> 	> https://pan.baidu.com/s/1p33ncwXEq1UmLEuEerVSKA?pwd=1111
> 	> 提取码：1111

